# NixOS Config - ThinkPad P14s Gen 6

## Structure

```
nixos-config/
├── flake.nix                          # Entry point - defines all hosts (shared modules extracted)
├── flake.lock                         # Pinned dependencies (auto-generated)
│
├── hosts/
│   ├── xps13/
│   │   ├── configuration.nix          # XPS 13: Intel Broadwell, no Docker, test bed
│   │   └── hardware-configuration.nix # Auto-generated by nixos-generate-config
│   ├── p14s/
│   │   ├── configuration.nix          # P14s-specific: AMD GPU, power mgmt, bluetooth
│   │   └── hardware-configuration.nix # Auto-generated by nixos-generate-config
│   └── desktop/                       # Future desktop host
│       ├── configuration.nix
│       └── hardware-configuration.nix
│
├── modules/
│   ├── common.nix                     # Shared system config: boot, networking, users, nix settings
│   ├── niri.nix                       # Niri compositor, greetd, fonts, wayland env
│   ├── docker.nix                     # Docker daemon + compose
│   └── staging-server.nix             # Future: nginx, tailscale, client staging
│
├── home/
│   ├── default.nix                    # Home-manager entry point
│   ├── niri.nix                       # Waybar, fuzzel, mako, swaylock, screenshots, clipboard
│   ├── shell.nix                      # Zsh, starship, direnv, git, CLI tools
│   ├── editors.nix                    # Neovim/LazyVim, Zed, Ghostty
│   ├── apps.nix                       # Chromium, PWAs, dev tools, Rust, Node
│   └── theme.nix                      # Stylix colors, GTK/QT, icons, cursor
│
└── templates/
    └── rust-nextjs-flake.nix          # Example per-project dev environment
```

## Getting Started

### 1. Boot NixOS installer USB

Download minimal ISO from https://nixos.org/download

### 2. Partition and encrypt

```bash
# Partition (adjust device name)
parted /dev/nvme0n1 -- mklabel gpt
parted /dev/nvme0n1 -- mkpart ESP fat32 1MB 1GB
parted /dev/nvme0n1 -- set 1 esp on
parted /dev/nvme0n1 -- mkpart primary 1GB 100%

# Encrypt root
cryptsetup luksFormat /dev/nvme0n1p2
cryptsetup open /dev/nvme0n1p2 cryptroot

# Format
mkfs.fat -F 32 -n BOOT /dev/nvme0n1p1
mkfs.ext4 -L nixos /dev/mapper/cryptroot
# or for btrfs:
# mkfs.btrfs -L nixos /dev/mapper/cryptroot

# Mount
mount /dev/mapper/cryptroot /mnt
mkdir -p /mnt/boot
mount /dev/nvme0n1p1 /mnt/boot
```

### 3. Generate hardware config

```bash
nixos-generate-config --root /mnt
# Copy the generated hardware-configuration.nix to hosts/p14s/
```

### 4. Clone this config

```bash
nix-shell -p git
git clone <your-repo-url> /mnt/etc/nixos
# Or copy files manually
```

### 5. Install

```bash
# For the Dell XPS 13:
nixos-install --flake /mnt/etc/nixos#xps13

# Later, for the P14s:
# nixos-install --flake /mnt/etc/nixos#p14s

reboot
```

### 6. Post-install

```bash
# Clone LazyVim starter
git clone https://github.com/LazyVim/starter ~/.config/nvim

# Set up project dev environments
cd ~/projects/my-rust-app
cp ~/nixos-config/templates/rust-nextjs-flake.nix flake.nix
echo "use flake" > .envrc
direnv allow

# Rebuild after config changes
sudo nixos-rebuild switch --flake ~/nixos-config#xps13
# (use #p14s on the ThinkPad, #desktop on the desktop)
```

## Key Commands

```bash
rebuild          # alias: nixos-rebuild switch
update           # alias: nix flake update
nix develop      # enter project dev shell
nix-collect-garbage -d  # clean old generations
```

## Adding the Desktop Host

When ready, uncomment the desktop section in flake.nix and create:
- `hosts/desktop/configuration.nix` (GPU drivers, X-Plane, nginx staging)
- `hosts/desktop/hardware-configuration.nix` (from nixos-generate-config)

Both machines share modules/ and home/ — only host-specific hardware
config differs. Rebuild with `--flake ~/nixos-config#desktop`.
